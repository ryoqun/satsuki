%class Turnstile
%package Turnstile
%header engine.hpp

%start MainMap::Normal

%map MainMap
%%
Normal
{
  keydown(event: KeyEvent) [ event.name == KEY_SPACE ]
    push(PreSpace)
    {}
  keydown(event: KeyEvent) [ event.name == KEY_SLASH ]
    push(PreSlashControl)
    {}
  keydown(event: KeyEvent) [ event.name == KEY_Z ]
    push(PreZKeyControl)
    {}
  keydown(event: KeyEvent) [ event.name == KEY_SHIFT ]
    push(Shift)
    {}
  keydown(event: KeyEvent) [ event.name == KEY_TENKEY ]
    push(Tenkey)
    {}
  keydown(event: KeyEvent)
    nil
    { emit(event); }
}

Shift
  Entry { shift_mode(True); }
  Exit { shift_mode(False); }
{
  keydown(event: KeyEvent)
    nil
    { emit(event); }
  keyup(event: KeyEvent) [ event.name == KEY_SHIFT ]
    pop
    {}
  keyup(event: KeyEvent)
    nil
    { emit(event); }
}

Tenkey
  Entry { tenkey_mode(True); }
  Exit { tenkey_mode(False); }
{
  keydown(event: KeyEvent)
    nil
    { emit(event); }
  keyup(event: KeyEvent) [ event.name == KEY_TENKEY ]
    pop
    {}
  keyup(event: KeyEvent)
    nil
    { emit(event); }
}

PreSpace {
  keyup(event: KeyEvent) [ event.name == KEY_SPACE ]
    pop
    { emit_space(); }

  keydown(event: KeyEvent) [ event.name == KEY_SLASH ]
    Space/push(PreSlashControl)
    {}

  keydown(event: KeyEvent) [ event.name == KEY_Z ]
    Space/push(PreZKeyControl)
    {}

  keydown(event: KeyEvent) [ event.name == KEY_SPACE ]
    Space
    {}

  keydown(event: KeyEvent)
    Space
    { space_mode(True); emit(event); }
}

Space
  Entry { space_mode(True); }
  Exit { space_mode(False); }
{
  keydown(event: KeyEvent) [ event.name == KEY_SLASH ]
    push(PreSlashControl)
    {}

  keydown(event: KeyEvent) [ event.name == KEY_Z ]
    push(PreZKeyControl)
    {}

  keydown(event: KeyEvent) [ event.name == KEY_SPACE ]
    nil
    {}

  keydown(event: KeyEvent)
    nil
    { emit(event); }

  keyup(event: KeyEvent) [ event.name == KEY_SPACE ]
    pop
    {}

  keyup(event: KeyEvent)
    nil
    { emit(event); }
}

PreZKeyControl {
  keydown(event: KeyEvent) [ event.name == KEY_Z ]
    ZKeyControl
    {}

  keydown(event: KeyEvent) [ event.name == KEY_SPACE ]
    ZKeyControl/push(PreSpace)
    {}

  keydown(event: KeyEvent)
    SemiZKeyControl
    { buffer(event);}

  keyup(event: KeyEvent) [ event.name == KEY_Z ]
    pop
    { emit_z(); }
}

PreSlashControl {
  keydown(event: KeyEvent) [ event.name == KEY_SLASH ]
    SlashControl
    {}

  keydown(event: KeyEvent) [ event.name == KEY_SPACE ]
    SlashControl/push(PreSpace)
    {}

  keydown(event: KeyEvent)
    SemiSlashControl
    { buffer(event); }

  keyup(event: KeyEvent) [ event.name == KEY_SLASH ]
    pop
    { emit_slash(); }
}

SemiZKeyControl {
  keydown(event: KeyEvent)
    ZKeyControl
    { control_mode(True); flush(); emit(event); }

  keyup(event: KeyEvent) [ event.name == KEY_Z ]
    pop
    { emit_z(); flush(); emit(event); }

  keyup(event: KeyEvent)
    ZKeyControl
    { control_mode(True); flush(); emit(event); }
}

SemiSlashControl {
  keydown(event: KeyEvent)
    SlashControl
    { control_mode(True); flush(); emit(event); }

  keyup(event: KeyEvent) [ event.name == KEY_SLASH ]
    pop
    { emit_slash(); flush(); emit(event); }

  keyup(event: KeyEvent)
    SlashControl
    { control_mode(True); flush(); emit(event); }
}

ZKeyControl
  Entry { control_mode(True); }
  Exit { control_mode(False); }
{
  keydown(event: KeyEvent) [ event.name == KEY_Z ]
    nil
    {}

  keydown(event: KeyEvent)
    nil
    { emit(event); }

  keyup(event: KeyEvent) [ event.name == KEY_Z ]
    pop
    {}

  keyup(event: KeyEvent)
    nil
    { emit(event); }
}

SlashControl
  Entry { control_mode(True); }
  Exit { control_mode(False); }
{
  keydown(event: KeyEvent) [ event.name == KEY_SLASH ]
    nil
    {}

  keydown(event: KeyEvent)
    nil
    { emit(event); }

  keyup(event: KeyEvent) [ event.name == KEY_SLASH ]
    pop
    {}

  keyup(event: KeyEvent)
    nil
    { emit(event); }
}
%%
